{% extends "base.html" %}

{% block title %}Dodaj przychód{% endblock %}

{% block body %}

<div class="row justify-content-center">
    <div class="col-xs-12 col-sm-9 col-lg-5 login-form-2">
            <h3>Dodaj Przychód</h3>

            {% if income.errors is not empty %}
            <dl style="color:red">
                <dt>Błędy:</dt>
            {% for error in income.errors %}
                <dd>{{ error }}</dd>
            {% endfor %}
            </dl>

            {% endif %}

            <form method = "post" action="/addincome/create" id="main" novalidate>
                <div class="form-group row">
                            <label for="amount" class="col-sm-2 control-label mt-3">Kwota: </label>
                            <div class="col-sm-10">
                                <input type="number"  class="form-control" id="amount" name="amount" step="0.01" value="{{ income.amount }}">
                            </div>
                            <div class="col-sm-12 messages"></div>
                </div>          
                <div class="form-group row"> 
                            <label for="date" class="col-sm-2 control-label mt-3" >Data: </label>
                            <div class="col-sm-10">
                                <input type="date"  class="form-control" id="date" name="date" value="{{ income.date }}">
                            </div>
                            <div class="col-sm-12 messages"></div>
                </div>  
                <div class="form-group row">       
                            <label for="category" class="col-sm-3 control-label mt-3">Kategoria:</label>
                            <div class="col-sm-9">
                            <select id="category" class="form-control" name="category" value="{{ income.category }}">
                                    <option value="">Wybierz...</option>
                                    <option value="wynagrodzenie">Wynagrodzenie</option>
                                    <option value="rodzice">Pieniądze od rodziców</option>
                                    <option value="odsetki bankowe">Odsetki bankowe</option>
                                    <option value="inne">Inne przychody</option>
                            </select>
                            </div>   
                            <div class="col-sm-12 messages"></div>   
                </div> 
                <div class="form-group row">     
                            <label for="inputComment" class="col-sm-4 control-label mt-1">Komentarz (opcjonalnie): </label>
                            <div class="col-sm-8">
                                <input class="form-control " id="inputComment" type="text" name="comment" value="{{ income.comment }}">
                            </div>
                </div>        
                <div class="col-sm-12 form-group">
                            <input type="submit" class="btnSubmit" value="Dodaj przychód" />
                </div>
                <div class="col-sm-12 form-group">
                            <a href="/">
                            <input type="button" class="btnAbort"  value="Anuluj" />
                            </a>
                </div>
            </form>
    </div>	
    </div>
    
{% endblock %}

{% block footer %}
		<script src="/js/app.js"></script>
    <script type="text/javascript">
      document.getElementById("date").valueAsDate = new Date();
    </script>
        <script>
            (function() {
              // These are the constraints used to validate the form
              var constraints = {
                amount: {
                  // Dodanie kwoty przychodu
                  presence: {
                      message: "^To pole jest wymagane.",
                  },
                  numericality: {
                    greaterThan: 0,
                    message: "^Kwota musi być większa od zera."
                  }
                },
                date: {
                  // Dodanie daty przychodu
                  presence: {
                      message: "^To pole jest wymagane.",
                  },
                },
                category: {
                  // Dodanie kategorii przychodu
                  presence: {
                      message: "^To pole jest wymagane.",
                  },
                },
              };
              // zapobieganie ewentualnemu wysłaniu formularza
              var form = document.querySelector("form#main");
              form.addEventListener("submit", function(ev) {
                ev.preventDefault();
                handleFormSubmit(form);
              });
        
              // sprawdzanie inputów w momencie ich wypełniania
              var inputs = document.querySelectorAll("input, textarea, select")
              for (var i = 0; i < inputs.length; ++i) {
                inputs.item(i).addEventListener("change", function(ev) {
                  var errors = validate(form, constraints) || {};
                  showErrorsForInput(this, errors[this.name])
                });
              }
        
              function handleFormSubmit(form, input) {
                //sprawdzenie zmiennych pod względem poprawności
                var errors = validate(form, constraints);
                // pózniej update formularza żęby pokazać rezultaty walidacji
                showErrors(form, errors || {});
                if(!errors){
                    form.submit();
                }
              }
        
              // funkcja pokazująca błędy walidacji
              function showErrors(form, errors) {
                // We loop through all the inputs and show the errors for that input
                _.each(form.querySelectorAll("input[name], select[name]"), function(input) {
                  // Since the errors can be null if no errors were found we need to handle
                  // that
                  showErrorsForInput(input, errors && errors[input.name]);
                });
              }
        
              // Shows the errors for a specific input
              function showErrorsForInput(input, errors) {
                // This is the root of the input
                var formGroup = closestParent(input.parentNode, "form-group")
                  // Find where the error messages will be insert into
                  , messages = formGroup.querySelector(".messages");
                // First we remove any old messages and resets the classes
                resetFormGroup(formGroup);
                // If we have errors
                if (errors) {
                  // we first mark the group has having errors
                  formGroup.classList.add("has-error");
                  // then we append all the errors
                  _.each(errors, function(error) {
                    addError(messages, error);
                  });
                } else {
                  // otherwise we simply mark it as success
                  formGroup.classList.add("has-success");
                }
              }
        
              // Recusively finds the closest parent that has the specified class
              function closestParent(child, className) {
                if (!child || child == document) {
                  return null;
                }
                if (child.classList.contains(className)) {
                  return child;
                } else {
                  return closestParent(child.parentNode, className);
                }
              }
        
              function resetFormGroup(formGroup) {
                // Remove the success and error classes
                formGroup.classList.remove("has-error");
                formGroup.classList.remove("has-success");
                // and remove any old messages
                _.each(formGroup.querySelectorAll(".help-block.error"), function(el) {
                  el.parentNode.removeChild(el);
                });
              }
        
              // Adds the specified error with the following markup
              // <p class="help-block error">[message]</p>
              function addError(messages, error) {
                var block = document.createElement("p");
                block.classList.add("help-block");
                block.classList.add("error");
                block.innerText = error;
                messages.appendChild(block);
              }
        
            })();
          </script>
            
{% endblock %}